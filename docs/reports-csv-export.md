# Reports CSV Export API

This document describes the CSV export functionality for reports that includes appointment data and respects daily, weekly, and monthly filters.

## Endpoint

```
GET /api/reports/export-csv
```

## Authentication

This endpoint requires authentication. Include the Bearer token in the Authorization header:

```
Authorization: Bearer {your-token}
```

## Query Parameters

| Parameter | Type | Required | Description | Default |
|-----------|------|----------|-------------|---------|
| `range` | string | No | Filter reports by time range. Options: `daily`, `weekly`, `monthly`, `all` | `daily` |

## Range Options

### Daily (`range=daily`)
Exports reports generated today only.

### Weekly (`range=weekly`)
Exports reports generated within the current week (Monday to Sunday).

### Monthly (`range=monthly`)
Exports reports generated within the current month.

### All (`range=all`)
Exports all reports without date filtering.

## Response

The API returns a CSV file that will be automatically downloaded to the user's device. The file contains the following headers:

- Report ID
- Report Type
- Generated At
- Generated By
- Notes
- Amount
- Payment Method
- Status
- Remarks 1
- Remarks 2
- Appointment ID
- Patient Name
- Contact Number
- Date
- Start Time
- End Time
- Duration
- Doctor Name
- Procedure
- Category
- Department
- Source
- Agent Name
- MR Number
- Appointment Notes

## Example Usage

### Export today's reports
```bash
curl -X GET "https://your-domain.com/api/reports/export-csv?range=daily" \
  -H "Authorization: Bearer {your-token}" \
  -H "Accept: text/csv" \
  --output "reports_daily_2025-01-15_14-30-00.csv"
```

### Export this week's reports
```bash
curl -X GET "https://your-domain.com/api/reports/export-csv?range=weekly" \
  -H "Authorization: Bearer {your-token}" \
  -H "Accept: text/csv" \
  --output "reports_weekly_2025-01-15_14-30-00.csv"
```

### Export this month's reports
```bash
curl -X GET "https://your-domain.com/api/reports/export-csv?range=monthly" \
  -H "Authorization: Bearer {your-token}" \
  -H "Accept: text/csv" \
  --output "reports_monthly_2025-01-15_14-30-00.csv"
```

### Export all reports
```bash
curl -X GET "https://your-domain.com/api/reports/export-csv?range=all" \
  -H "Authorization: Bearer {your-token}" \
  -H "Accept: text/csv" \
  --output "reports_all_2025-01-15_14-30-00.csv"
```

## Frontend Integration

### React/JavaScript Example

```javascript
const exportReportsCsv = async (range = 'daily') => {
  try {
    const response = await fetch(`/api/reports/export-csv?range=${range}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Accept': 'text/csv'
      }
    });

    if (response.ok) {
      // Get the filename from the Content-Disposition header
      const contentDisposition = response.headers.get('Content-Disposition');
      const filename = contentDisposition.split('filename=')[1].replace(/"/g, '');
      
      // Create blob and download
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
    }
  } catch (error) {
    console.error('Error exporting CSV:', error);
  }
};

// Usage examples
exportReportsCsv('daily');    // Export today's reports
exportReportsCsv('weekly');   // Export this week's reports
exportReportsCsv('monthly');  // Export this month's reports
exportReportsCsv('all');      // Export all reports
```

### HTML Button Example

```html
<button onclick="exportReportsCsv('daily')">Export Today's Reports</button>
<button onclick="exportReportsCsv('weekly')">Export This Week's Reports</button>
<button onclick="exportReportsCsv('monthly')">Export This Month's Reports</button>
<button onclick="exportReportsCsv('all')">Export All Reports</button>
```

## Error Handling

The API returns appropriate HTTP status codes:

- `200 OK`: CSV file generated successfully
- `422 Unprocessable Entity`: Invalid range parameter
- `500 Internal Server Error`: Server error during CSV generation

## Notes

- The CSV file includes comprehensive data from both reports and their associated appointments
- All relationships (doctor, procedure, category, department, source, agent, remarks, status) are properly loaded
- The filename includes the range and timestamp for easy identification
- The CSV is properly formatted with proper escaping for commas and quotes
- The endpoint respects the same authentication and authorization as other report endpoints
- **The CSV file will automatically download to the user's default Downloads folder**
- The browser will handle the download automatically due to the `Content-Disposition: attachment` header
