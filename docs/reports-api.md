# Reports API

This document describes the reports endpoints with comprehensive filtering capabilities.

## Authentication
All endpoints require Sanctum authentication and are behind `auth:sanctum` + custom token middleware. Include a Bearer token:

```
Authorization: Bearer <token>
Accept: application/json
```

## List Reports with Optional Filtering
- Endpoint: `GET /api/reports`
- Supports multiple filter parameters that can be combined
- Only applies filters that are provided and not empty
- If no filters are provided, returns all reports with pagination

### Available Filters:

**📅 Date Filters (Appointment Dates):**
- `start_date` - Filter reports for appointments from this date onwards (YYYY-MM-DD)
- `end_date` - Filter reports for appointments until this date (YYYY-MM-DD)
- Can be used individually or together for date range filtering

**📋 Report Filters:**
- `report_type` - Filter by report type (string, e.g., "appointment_summary")
- `generated_by_id` - Filter by user who generated the report (integer)
- `appointment_id` - Filter by specific appointment (integer)
- `status_id` - Filter by report status (integer)
- `remarks_1_id` - Filter by remarks1 (integer)
- `remarks_2_id` - Filter by remarks2 (integer)

**💰 Amount & Payment Filters:**
- `amount_min` - Filter reports with amount >= this value (numeric)
- `amount_max` - Filter reports with amount <= this value (numeric)
- `payment_method` - Filter by payment method (string, partial match)

**🏥 Appointment-Related Filters:**
- `doctor_id` - Filter by doctor (integer)
- `department_id` - Filter by department (integer)
- `procedure_id` - Filter by procedure (integer)
- `category_id` - Filter by category (integer)
- `source_id` - Filter by source (integer)
- `agent_id` - Filter by agent (integer)

**🔍 Text Search Filters:**
- `search` - General search across report type, notes, generated by user, and appointment details
- `patient_name` - Search by patient name (partial match)
- `contact_number` - Search by contact number (partial match)
- `mr_number` - Search by MR number (partial match)

**⏰ Time Filters (Appointment Times):**
- `start_time` - Filter by appointment start time from this time onwards (HH:MM:SS format, e.g., "09:00:00")
- `end_time` - Filter by appointment start time until this time (HH:MM:SS format, e.g., "17:00:00")
- `duration` - Filter by appointment duration in minutes (integer, e.g., 60)
- Can be used individually or together for time range filtering

**📝 Important Note:** 
- **Date filters** (`start_date`, `end_date`) filter by **appointment dates**
- **Time filters** (`start_time`, `end_time`, `duration`) filter by **appointment times**

**📄 Pagination & Ordering:**
- `per_page` - Results per page (1-100, default 20)
- `page` - Page number (default 1)
- `order_by` - Sort field (generated_at, report_type, amount, created_at, updated_at)
- `order_direction` - Sort direction (asc, desc)

### Example Requests:

**Get all reports:**
```
GET /api/reports
```

**Filter by appointment date range:**
```
GET /api/reports?start_date=2024-01-01&end_date=2024-01-31
```

**Filter by appointment from specific date:**
```
GET /api/reports?start_date=2024-01-01
```

**Filter by appointment time range:**
```
GET /api/reports?start_time=09:00:00&end_time=17:00:00
```

**Filter by appointment start time from specific time:**
```
GET /api/reports?start_time=09:00:00
```

**Filter by appointment start time until specific time:**
```
GET /api/reports?end_time=12:00:00
```

**Filter by report type and amount range:**
```
GET /api/reports?report_type=appointment_summary&amount_min=100&amount_max=500
```

**Filter by doctor and department:**
```
GET /api/reports?doctor_id=5&department_id=1
```

**Search by patient name:**
```
GET /api/reports?patient_name=John
```


**Filter by specific procedure:**
```
GET /api/reports?procedure_id=5
```

**Filter by status:**
```
GET /api/reports?status_id=1
```

**Filter by duration:**
```
GET /api/reports?duration=60
```

**Complex filtering (report date + appointment time + procedure + status):**
```
GET /api/reports?start_date=2024-01-01&end_date=2024-01-31&start_time=09:00:00&end_time=12:00:00&procedure_id=3&status_id=1&department_id=1
```

**Example: Reports generated in January 2024 for morning appointments (9-12 AM) with specific procedure and status**

**Complex filtering:**
```
GET /api/reports?start_date=2024-01-01&end_date=2024-01-31&report_type=appointment_summary&doctor_id=5&amount_min=100&per_page=10&order_by=generated_at&order_direction=desc
```

### Example Response (with filters):
```json
{
  "status": "success",
  "data": {
    "current_page": 1,
    "data": [
      {
        "id": 123,
        "appointment_id": 456,
        "report_type": "appointment_summary",
        "generated_at": "2024-01-20T10:00:00.000000Z",
        "amount": 250.00,
        "payment_method": "Cash",
        "notes": "Follow-up required",
        "summary_data": {
          "patient_name": "John Doe",
          "doctor_name": "Dr. Smith",
          "procedure_name": "Consultation",
          "department_name": "Cardiology"
        },
        "appointment": {
          "id": 456,
          "patient_name": "John Doe",
          "date": "2024-01-20",
          "start_time": "10:00:00",
          "end_time": "11:00:00",
          "doctor": {"id": 5, "name": "Dr. Smith"},
          "department": {"id": 1, "name": "Cardiology"},
          "procedure": {"id": 3, "name": "Consultation"}
        },
        "generatedBy": {"id": 2, "name": "Agent Name"},
        "status": {"id": 1, "name": "Completed"},
        "remarks1": {"id": 1, "name": "Follow-up"},
        "remarks2": {"id": 2, "name": "Satisfied"}
      }
    ],
    "per_page": 10,
    "total": 25
  },
  "filters_applied": {
    "start_date": "2024-01-01",
    "end_date": "2024-01-31",
    "report_type": "appointment_summary",
    "doctor_id": "5"
  }
}
```

### Example Response (without filters):
```json
{
  "status": "success",
  "data": {
    "current_page": 1,
    "data": [...],
    "per_page": 20,
    "total": 150
  }
}
```

## Create Report
- Endpoint: `POST /api/reports`

Request body example:
```json
{
  "appointment_id": 456,
  "report_type": "appointment_summary",
  "summary_data": {
    "patient_name": "John Doe",
    "doctor_name": "Dr. Smith"
  },
  "notes": "Patient follow-up required",
  "generated_by_id": 2,
  "amount": 250.00,
  "payment_method": "Cash",
  "remarks_1_id": 1,
  "remarks_2_id": 2,
  "status_id": 1
}
```

## Update Report
- Endpoint: `PUT /api/reports/{id}`
- Accepts any subset of fields from create

## Delete Report
- Endpoint: `DELETE /api/reports/{id}`

## Generate Report from Appointment
- Endpoint: `POST /api/reports/generate-from-appointment`

Request body example:
```json
{
  "appointment_id": 456,
  "report_type": "appointment_summary",
  "notes": "Additional notes",
  "generated_by_id": 2,
  "amount": 250.00,
  "payment_method": "Cash",
  "remarks_1_id": 1,
  "remarks_2_id": 2,
  "status_id": 1
}
```

## Export Reports to CSV
- Endpoint: `GET /api/reports/export-csv`
- Query parameter: `range` (daily, weekly, monthly, all)

Example:
```
GET /api/reports/export-csv?range=monthly
```

## Get Report Statistics
- Endpoint: `GET /api/reports/stats`
- Optional query parameters: `start_date`, `end_date`

Example:
```
GET /api/reports/stats?start_date=2024-01-01&end_date=2024-01-31
```

## Other Endpoints

### Get Reports by Type
- Endpoint: `GET /api/reports/type/{type}`

### Get Reports by Generated User
- Endpoint: `GET /api/reports/generated-by/{user}`

### Get Reports by Date Range
- Endpoint: `GET /api/reports/date-range`
- Query parameters: `start_date`, `end_date`

### Get Reports for Specific Appointment
- Endpoint: `GET /api/reports/appointment/{appointmentId}`

### Search Reports
- Endpoint: `GET /api/reports/search`
- Query parameters: `search`, `start_date`, `end_date`, `type`, `generated_by`, `appointment_id`

## Error Responses

All endpoints return consistent error responses:

```json
{
  "status": "error",
  "message": "Error description",
  "error": "Detailed error message"
}
```

Common HTTP status codes:
- `200` - Success
- `201` - Created
- `400` - Bad Request (validation errors)
- `404` - Not Found
- `500` - Internal Server Error