<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports Filters Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background: #fafafa; }
        .section h3 { margin-top: 0; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
        .form-group { margin: 10px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 3px; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 3px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .example-btn { background: #28a745; }
        .example-btn:hover { background: #1e7e34; }
        .results { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; }
        .report { margin: 10px 0; padding: 15px; background: white; border: 1px solid #ddd; border-radius: 5px; }
        .error { color: red; margin: 10px 0; padding: 10px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 3px; }
        .success { color: green; margin: 10px 0; padding: 10px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 3px; }
        .url-display { background: #e9ecef; padding: 10px; border-radius: 3px; font-family: monospace; margin: 10px 0; word-break: break-all; }
        .filter-info { background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 3px; margin: 10px 0; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Reports Filters Test</h1>
        <p>Test the comprehensive filtering functionality for reports with multiple filter options.</p>

        <div class="filter-info">
            <strong>Available Filters:</strong><br>
            <strong>üìÖ Date:</strong> start_date, end_date<br>
            <strong>üìã Report:</strong> report_type, generated_by_id, appointment_id, status_id, remarks_1_id, remarks_2_id<br>
            <strong>üí∞ Amount:</strong> amount_min, amount_max, payment_method<br>
            <strong>üè• Appointment:</strong> doctor_id, department_id, procedure_id, category_id, source_id, agent_id<br>
            <strong>‚è∞ Time:</strong> start_time, end_time, duration<br>
            <strong>üîç Search:</strong> search, patient_name, contact_number, mr_number
        </div>

        <form id="filterForm">
            <div class="section">
                <h3>üìÖ Date Filters (Appointment Dates)</h3>
                <div class="grid-2">
                    <div class="form-group">
                        <label for="start_date">Appointment From:</label>
                        <input type="date" id="start_date" name="start_date">
                    </div>
                    <div class="form-group">
                        <label for="end_date">Appointment Until:</label>
                        <input type="date" id="end_date" name="end_date">
                    </div>
                </div>
                <div style="background: #e3f2fd; padding: 8px; border-radius: 3px; margin-top: 10px; font-size: 0.9em; color: #1976d2;">
                    <strong>Note:</strong> These filters apply to appointment dates.
                </div>
            </div>

            <div class="section">
                <h3>üìã Report Filters</h3>
                <div class="grid-3">
                    <div class="form-group">
                        <label for="report_type">Report Type:</label>
                        <input type="text" id="report_type" name="report_type" placeholder="e.g., appointment_summary">
                    </div>
                    <div class="form-group">
                        <label for="generated_by_id">Generated By ID:</label>
                        <input type="number" id="generated_by_id" name="generated_by_id" min="1" placeholder="e.g., 2">
                    </div>
                    <div class="form-group">
                        <label for="appointment_id">Appointment ID:</label>
                        <input type="number" id="appointment_id" name="appointment_id" min="1" placeholder="e.g., 456">
                    </div>
                </div>
                <div class="grid-3">
                    <div class="form-group">
                        <label for="status_id">Status ID:</label>
                        <input type="number" id="status_id" name="status_id" min="1" placeholder="e.g., 1">
                    </div>
                    <div class="form-group">
                        <label for="remarks_1_id">Remarks 1 ID:</label>
                        <input type="number" id="remarks_1_id" name="remarks_1_id" min="1" placeholder="e.g., 1">
                    </div>
                    <div class="form-group">
                        <label for="remarks_2_id">Remarks 2 ID:</label>
                        <input type="number" id="remarks_2_id" name="remarks_2_id" min="1" placeholder="e.g., 2">
                    </div>
                </div>
            </div>

            <div class="section">
                <h3>üí∞ Amount & Payment Filters</h3>
                <div class="grid-3">
                    <div class="form-group">
                        <label for="amount_min">Min Amount:</label>
                        <input type="number" id="amount_min" name="amount_min" min="0" step="0.01" placeholder="e.g., 100">
                    </div>
                    <div class="form-group">
                        <label for="amount_max">Max Amount:</label>
                        <input type="number" id="amount_max" name="amount_max" min="0" step="0.01" placeholder="e.g., 500">
                    </div>
                    <div class="form-group">
                        <label for="payment_method">Payment Method:</label>
                        <input type="text" id="payment_method" name="payment_method" placeholder="e.g., Cash, Card">
                    </div>
                </div>
            </div>

            <div class="section">
                <h3>üè• Appointment-Related Filters</h3>
                <div class="grid-3">
                    <div class="form-group">
                        <label for="doctor_id">Doctor ID:</label>
                        <input type="number" id="doctor_id" name="doctor_id" min="1" placeholder="e.g., 5">
                    </div>
                    <div class="form-group">
                        <label for="department_id">Department ID:</label>
                        <input type="number" id="department_id" name="department_id" min="1" placeholder="e.g., 1">
                    </div>
                    <div class="form-group">
                        <label for="procedure_id">Procedure ID:</label>
                        <input type="number" id="procedure_id" name="procedure_id" min="1" placeholder="e.g., 3">
                    </div>
                </div>
                <div class="grid-3">
                    <div class="form-group">
                        <label for="category_id">Category ID:</label>
                        <input type="number" id="category_id" name="category_id" min="1" placeholder="e.g., 2">
                    </div>
                    <div class="form-group">
                        <label for="source_id">Source ID:</label>
                        <input type="number" id="source_id" name="source_id" min="1" placeholder="e.g., 4">
                    </div>
                    <div class="form-group">
                        <label for="agent_id">Agent ID:</label>
                        <input type="number" id="agent_id" name="agent_id" min="1" placeholder="e.g., 1">
                    </div>
                </div>
            </div>

            <div class="section">
                <h3>‚è∞ Time Filters (Appointment Times)</h3>
                <div class="grid-3">
                    <div class="form-group">
                        <label for="start_time">Appointment Start Time:</label>
                        <input type="time" id="start_time" name="start_time" step="1">
                    </div>
                    <div class="form-group">
                        <label for="end_time">Appointment End Time:</label>
                        <input type="time" id="end_time" name="end_time" step="1">
                    </div>
                    <div class="form-group">
                        <label for="duration">Appointment Duration (minutes):</label>
                        <input type="number" id="duration" name="duration" min="1" placeholder="e.g., 60">
                    </div>
                </div>
                <div style="background: #fff3cd; padding: 8px; border-radius: 3px; margin-top: 10px; font-size: 0.9em; color: #856404;">
                    <strong>Note:</strong> These filters apply to the appointment times, not when the report was generated.
                </div>
            </div>

            <div class="section">
                <h3>üîç Text Search Filters</h3>
                <div class="grid-2">
                    <div class="form-group">
                        <label for="search">General Search:</label>
                        <input type="text" id="search" name="search" placeholder="Search across all fields">
                    </div>
                    <div class="form-group">
                        <label for="patient_name">Patient Name:</label>
                        <input type="text" id="patient_name" name="patient_name" placeholder="e.g., John">
                    </div>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label for="contact_number">Contact Number:</label>
                        <input type="text" id="contact_number" name="contact_number" placeholder="e.g., 9876543210">
                    </div>
                    <div class="form-group">
                        <label for="mr_number">MR Number:</label>
                        <input type="text" id="mr_number" name="mr_number" placeholder="e.g., MR-1001">
                    </div>
                </div>
            </div>

            <div class="section">
                <h3>üìÑ Pagination & Ordering</h3>
                <div class="grid-3">
                    <div class="form-group">
                        <label for="per_page">Per Page:</label>
                        <select id="per_page" name="per_page">
                            <option value="5">5</option>
                            <option value="10">10</option>
                            <option value="20" selected>20</option>
                            <option value="50">50</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="order_by">Order By:</label>
                        <select id="order_by" name="order_by">
                            <option value="generated_at" selected>Generated At</option>
                            <option value="report_type">Report Type</option>
                            <option value="amount">Amount</option>
                            <option value="created_at">Created At</option>
                            <option value="updated_at">Updated At</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="order_direction">Order Direction:</label>
                        <select id="order_direction" name="order_direction">
                            <option value="desc" selected>Descending</option>
                            <option value="asc">Ascending</option>
                        </select>
                    </div>
                </div>
            </div>

            <button type="submit">üîç Filter Reports</button>
            <button type="button" class="example-btn" onclick="loadExample('recent')">üìÖ Recent Reports (Last 7 days)</button>
            <button type="button" class="example-btn" onclick="loadExample('amount')">üí∞ High Value Reports (>500)</button>
            <button type="button" class="example-btn" onclick="loadExample('doctor')">üë®‚Äç‚öïÔ∏è Reports by Doctor</button>
            <button type="button" class="example-btn" onclick="loadExample('type')">üìã Appointment Summary Reports</button>
            <button type="button" class="example-btn" onclick="loadExample('morning')">üåÖ Morning Appointments (9-12)</button>
            <button type="button" class="example-btn" onclick="loadExample('afternoon')">üåû Afternoon Appointments (12+)</button>
            <button type="button" class="example-btn" onclick="loadExample('procedure')">üî¨ Specific Procedure</button>
            <button type="button" class="example-btn" onclick="loadExample('status')">üìã Specific Status</button>
            <button type="button" class="example-btn" onclick="loadExample('combined')">üîÑ Combined: Report Date + Appointment Time</button>
            <button type="button" class="example-btn" onclick="clearFilters()">üóëÔ∏è Clear All</button>
        </form>

        <div id="urlDisplay" class="url-display" style="display: none;"></div>

        <div id="results" class="results" style="display: none;">
            <h3>üìã Results</h3>
            <div id="resultContent"></div>
        </div>

        <div id="error" class="error" style="display: none;"></div>
        <div id="success" class="success" style="display: none;"></div>
    </div>

    <script>
        function loadExample(type) {
            clearFilters();
            
            const today = new Date();
            const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            switch(type) {
                case 'recent':
                    document.getElementById('start_date').value = lastWeek.toISOString().split('T')[0];
                    document.getElementById('end_date').value = today.toISOString().split('T')[0];
                    break;
                case 'amount':
                    document.getElementById('amount_min').value = '500';
                    break;
                case 'doctor':
                    document.getElementById('doctor_id').value = '5';
                    break;
                case 'type':
                    document.getElementById('report_type').value = 'appointment_summary';
                    break;
                case 'morning':
                    document.getElementById('start_time').value = '09:00:00';
                    document.getElementById('end_time').value = '12:00:00';
                    break;
                case 'afternoon':
                    document.getElementById('start_time').value = '12:00:00';
                    break;
                case 'procedure':
                    document.getElementById('procedure_id').value = '3';
                    break;
                case 'status':
                    document.getElementById('status_id').value = '1';
                    break;
                case 'combined':
                    // Set report generation date (last 7 days)
                    document.getElementById('start_date').value = lastWeek.toISOString().split('T')[0];
                    document.getElementById('end_date').value = today.toISOString().split('T')[0];
                    // Set appointment time (morning)
                    document.getElementById('start_time').value = '09:00:00';
                    document.getElementById('end_time').value = '12:00:00';
                    break;
            }
        }
        
        function clearFilters() {
            document.getElementById('filterForm').reset();
            document.getElementById('results').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('success').style.display = 'none';
            document.getElementById('urlDisplay').style.display = 'none';
        }

        document.getElementById('filterForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const params = new URLSearchParams();
            
            // Only add non-empty values to the query string
            for (let [key, value] of formData.entries()) {
                if (value.trim() !== '') {
                    params.append(key, value);
                }
            }
            
            const queryString = params.toString();
            const url = `/api/reports${queryString ? '?' + queryString : ''}`;
            
            // Display the URL being called
            document.getElementById('urlDisplay').textContent = `GET ${url}`;
            document.getElementById('urlDisplay').style.display = 'block';
            
            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Authorization': 'Bearer ' + getAuthToken()
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    displayResults(data);
                    showSuccess(`Found ${data.data.total} reports`);
                } else {
                    showError(data.message || 'Failed to fetch reports');
                }
            } catch (error) {
                showError('Network error: ' + error.message);
            }
        });
        
        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            const contentDiv = document.getElementById('resultContent');
            
            let html = `
                <div style="background: #e3f2fd; padding: 10px; border-radius: 3px; margin-bottom: 15px;">
                    <strong>üìä Summary:</strong> ${data.data.total} total reports | 
                    Page ${data.data.current_page} of ${data.data.last_page} | 
                    ${data.data.per_page} per page
                </div>
            `;
            
            if (data.filters_applied && Object.keys(data.filters_applied).length > 0) {
                html += `
                    <div style="background: #f3e5f5; padding: 10px; border-radius: 3px; margin-bottom: 15px;">
                        <strong>üîç Filters Applied:</strong><br>
                        ${Object.entries(data.filters_applied).map(([key, value]) => 
                            `<span style="background: #fff; padding: 2px 6px; margin: 2px; border-radius: 3px; display: inline-block;">${key}: ${value}</span>`
                        ).join('')}
                    </div>
                `;
            }
            
            if (data.data.data && data.data.data.length > 0) {
                data.data.data.forEach(report => {
                    const generatedAt = report.generated_at ? new Date(report.generated_at).toLocaleString() : 'N/A';
                    const amount = report.amount ? `$${parseFloat(report.amount).toFixed(2)}` : 'N/A';
                    
                    html += `
                        <div class="report">
                            <h4>üìä Report #${report.id}</h4>
                            <div class="grid-2">
                                <div>
                                    <strong>üìã Type:</strong> ${report.report_type || 'N/A'}<br>
                                    <strong>üìÖ Generated:</strong> ${generatedAt}<br>
                                    <strong>üë§ Generated By:</strong> ${report.generatedBy ? report.generatedBy.name : 'N/A'}<br>
                                    <strong>üí∞ Amount:</strong> ${amount}<br>
                                    <strong>üí≥ Payment:</strong> ${report.payment_method || 'N/A'}
                                </div>
                                <div>
                                    <strong>üìã Status:</strong> ${report.status ? report.status.name : 'N/A'}<br>
                                    <strong>üìù Remarks 1:</strong> ${report.remarks1 ? report.remarks1.name : 'N/A'}<br>
                                    <strong>üìù Remarks 2:</strong> ${report.remarks2 ? report.remarks2.name : 'N/A'}<br>
                                    <strong>üìã Appointment ID:</strong> ${report.appointment_id || 'N/A'}
                                </div>
                            </div>
                            
                            ${report.appointment ? `
                                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                                    <h5>üìÖ Related Appointment:</h5>
                                    <div class="grid-2">
                                        <div>
                                            <strong>üë§ Patient:</strong> ${report.appointment.patient_name || 'N/A'}<br>
                                            <strong>üìÖ Date:</strong> ${report.appointment.date || 'N/A'}<br>
                                            <strong>‚è∞ Time:</strong> ${report.appointment.start_time || 'N/A'} - ${report.appointment.end_time || 'N/A'}
                                        </div>
                                        <div>
                                            <strong>üë®‚Äç‚öïÔ∏è Doctor:</strong> ${report.appointment.doctor ? report.appointment.doctor.name : 'N/A'}<br>
                                            <strong>üè• Department:</strong> ${report.appointment.department ? report.appointment.department.name : 'N/A'}<br>
                                            <strong>üî¨ Procedure:</strong> ${report.appointment.procedure ? report.appointment.procedure.name : 'N/A'}
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${report.notes ? `
                                <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 3px;">
                                    <strong>üìù Notes:</strong> ${report.notes}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
            } else {
                html += '<div style="text-align: center; padding: 20px; color: #666;">No reports found matching the criteria.</div>';
            }
            
            contentDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('success').style.display = 'none';
            document.getElementById('results').style.display = 'none';
        }
        
        function showSuccess(message) {
            const successDiv = document.getElementById('success');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            document.getElementById('error').style.display = 'none';
        }
        
        function getAuthToken() {
            // This is a placeholder - you'll need to implement proper token retrieval
            return prompt('Enter your Bearer token:') || '';
        }
    </script>
</body>
</html>
